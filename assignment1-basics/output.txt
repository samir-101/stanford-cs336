============================= test session starts ==============================
platform linux -- Python 3.13.9, pytest-8.4.1, pluggy-1.6.0
rootdir: /home/samirhassan/stanford-cs336/assignment1-basics
configfile: pyproject.toml
plugins: jaxtyping-0.3.2
collected 13 items / 12 deselected / 1 selected

tests/test_model.py::test_multihead_self_attention DEBUG: q shape torch.Size([4, 12, 64])
DEBUG: q reshaped torch.Size([4, 4, 12, 16])
DEBUG: output after attn torch.Size([4, 4, 12, 16])
DEBUG: output reshaped torch.Size([4, 12, 64])
FAILED

=================================== FAILURES ===================================
________________________ test_multihead_self_attention _________________________

numpy_snapshot = <tests.conftest.NumpySnapshot object at 0x7af599ee4440>
in_embeddings = tensor([[[-0.9414,  1.2632, -0.1838,  ..., -0.1941,  0.0048, -1.3165],
         [ 0.0204, -0.1652,  0.2109,  ...,  0.6...73, -0.5486,  ...,  1.5676, -1.1472, -1.5822],
         [ 1.5936, -0.4113,  0.6037,  ..., -0.6494,  1.2858,  0.4321]]])
d_model = 64, n_heads = 4
ts_state_dict = ({'layers.0.attn.k_proj.weight': tensor([[ 0.0890,  0.1049,  0.0980,  ...,  0.1314,  0.0594, -0.0206],
        [ 0.027...7,  ...,  0.0380, -0.0240,  0.1170]]), ...}, {'context_length': 16, 'd_ff': 128, 'd_model': 64, 'ffn_type': None, ...})

    def test_multihead_self_attention(numpy_snapshot, in_embeddings, d_model, n_heads, ts_state_dict):
        d, _ = ts_state_dict
        q_proj_weight, k_proj_weight, v_proj_weight, o_proj_weight = [
            d[f"layers.0.attn.{k}_proj.weight"] for k in ["q", "k", "v", "output"]
        ]
        actual_output = run_multihead_self_attention(
            d_model=d_model,
            num_heads=n_heads,
            q_proj_weight=q_proj_weight,
            k_proj_weight=k_proj_weight,
            v_proj_weight=v_proj_weight,
            o_proj_weight=o_proj_weight,
            in_features=in_embeddings,
        )
>       numpy_snapshot.assert_match(actual_output, atol=1e-6)

tests/test_model.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <tests.conftest.NumpySnapshot object at 0x7af599ee4440>
actual = tensor([[[-0.0849, -0.1536, -0.1372,  ..., -0.1614,  0.0040, -0.0977],
         [ 0.0397, -0.1997, -0.0033,  ..., -0.0...93,  0.0093,  ...,  0.0170,  0.1358,  0.0051],
         [-0.0072, -0.0887, -0.0064,  ...,  0.0452,  0.1754, -0.1087]]])
rtol = 0.0001, atol = 1e-06, test_name = 'test_multihead_self_attention'
force_update = False

    def assert_match(
        self,
        actual: _A | dict[str, _A],
        rtol: float = 1e-4,
        atol: float = 1e-2,
        test_name: str | type[DEFAULT] = DEFAULT,
        force_update: bool | type[DEFAULT] = DEFAULT,
    ):
        """
        Assert that the actual array(s) matches the snapshot.
    
        Args:
            actual: Single NumPy array or dictionary of named arrays
            test_name: The name of the test (used for the snapshot file)
            update: If True, update the snapshot instead of comparing
        """
        if force_update is DEFAULT:
            force_update = self.default_force_update
        if self.always_match_exact:
            rtol = atol = 0
        if test_name is DEFAULT:
            assert self.default_test_name is not None, "Test name must be provided or set as default"
            test_name = self.default_test_name
    
        snapshot_path = self._get_snapshot_path(test_name)
    
        # Convert single array to dictionary for consistent handling
        arrays_dict = actual if isinstance(actual, dict) else {"array": actual}
        arrays_dict = {k: _canonicalize_array(v) for k, v in arrays_dict.items()}
    
        # Load the snapshot
        expected_arrays = dict(np.load(snapshot_path))
    
        # Verify all expected arrays are present
        missing_keys = set(arrays_dict.keys()) - set(expected_arrays.keys())
        if missing_keys:
            raise AssertionError(f"Keys {missing_keys} not found in snapshot for {test_name}")
    
        # Verify all actual arrays are expected
        extra_keys = set(expected_arrays.keys()) - set(arrays_dict.keys())
        if extra_keys:
            raise AssertionError(f"Snapshot contains extra keys {extra_keys} for {test_name}")
    
        # Compare all arrays
        for key in arrays_dict:
>           np.testing.assert_allclose(
                _canonicalize_array(arrays_dict[key]),
                expected_arrays[key],
                rtol=rtol,
                atol=atol,
                err_msg=f"Array '{key}' does not match snapshot for {test_name}",
            )
E           AssertionError: 
E           Not equal to tolerance rtol=0.0001, atol=1e-06
E           Array 'array' does not match snapshot for test_multihead_self_attention
E           Mismatched elements: 2816 / 3072 (91.7%)
E           Max absolute difference among violations: 1.0387611
E           Max relative difference among violations: 245.33488
E            ACTUAL: array([[[-0.084945, -0.153629, -0.137208, ..., -0.161399,  0.003991,
E                    -0.09765 ],
E                   [ 0.039706, -0.199675, -0.003256, ..., -0.094592, -0.077092,...
E            DESIRED: array([[[-0.240338,  0.141964, -0.04017 , ..., -0.746504, -0.343374,
E                    -0.195468],
E                   [ 0.124074, -0.107155, -0.14378 , ..., -0.386787, -0.425394,...

tests/conftest.py:89: AssertionError
=========================== short test summary info ============================
FAILED tests/test_model.py::test_multihead_self_attention - AssertionError: 
======================= 1 failed, 12 deselected in 0.05s =======================
